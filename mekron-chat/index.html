<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mekron • Chat</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2d;--ink:#eaf0ff;--muted:#9fb0d3;--accent:#6ea8ff;--ok:#27d17f;--err:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;gap:10px;padding:16px 20px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0))}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    #chat{padding:16px;height:60vh;overflow:auto}
    .row{margin:8px 0;line-height:1.7;white-space:pre-wrap}
    .me{color:#c7e2ff}
    .bot{color:#d9ffe2}
    .sys{color:var(--muted);font-size:.95em}
    form{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,.08)}
    input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:var(--ink);outline:none}
    button{padding:12px 18px;border-radius:12px;border:none;background:var(--accent);color:#04132a;font-weight:700;cursor:pointer;min-width:96px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{color:var(--muted);font-size:.9em;padding:0 16px 12px}
    .badge{font-size:.8em;background:#0e223b;border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px;color:#9fc0ff}
    .loader{display:inline-block; width:1em; height:1em; border:.16em solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; vertical-align:-.2em}
    @keyframes spin{to{transform:rotate(360deg)}}
    a{color:#9fc0ff}
  </style>
</head>
<body>
  <header class="wrap">
    <img src="https://avatars.githubusercontent.com/u/9919?s=40" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;filter:hue-rotate(210deg)">
    <h2 style="margin:0">Mekron <span class="badge">AI Assistant • 24/7</span></h2>
  </header>

  <main class="wrap card">
    <div id="chat"></div>
    <div class="hint">اكتب رسالتك واضغط <b>Send</b>. يتصل مباشرة بوبهوك <b>n8n</b>.</div>
    <form id="form" autocomplete="off">
      <input id="prompt" placeholder="اكتب سؤالك هنا..." />
      <button id="send" type="submit">Send</button>
    </form>
  </main>

  <script>
    // ⛳ ضع هنا رابط الويبهوك بتاع n8n (POST)
    // مثال: "https://n8n.yourdomain.com/webhook/abcd1234"
    const N8N_WEBHOOK = "PUT_YOUR_N8N_WEBHOOK_URL_HERE";

    const form  = document.getElementById('form');
    const input = document.getElementById('prompt');
    const chat  = document.getElementById('chat');
    const send  = document.getElementById('send');

    // معرف بسيط للجلسة (لو محتاجه في n8n)
    const sessionId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());

    function addRow(text, who){
      const div = document.createElement('div');
      div.className = 'row ' + (who || 'sys');
      div.textContent = (who === 'me' ? '👤 ' : who === 'bot' ? '🤖 ' : 'ℹ️ ') + text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return div;
    }

    function extractTextFromUnknown(data, fallbackText){
      if (!data) return fallbackText || '';
      // حاول نلقى نص الرد حسب أكثر أسماء شائعة
      if (typeof data === 'string') return data;
      if (data.reply) return data.reply;
      if (data.answer) return data.answer;
      if (data.message) return data.message;
      if (data.text) return data.text;
      if (data.data && typeof data.data === 'string') return data.data;
      // لو n8n مرجّع array من رسائل
      if (Array.isArray(data) && data.length) {
        const first = data[0];
        return extractTextFromUnknown(first, fallbackText);
      }
      // آخر حل: نحول JSON لنص
      try { return JSON.stringify(data, null, 2); } catch { return fallbackText || 'No response'; }
    }

    async function sendMessage(e){
      e.preventDefault();
      const text = (input.value || '').trim();
      if(!text) return;

      // حماية: لازم المستخدم يغير عنوان الويبهوك
      if (!N8N_WEBHOOK || N8N_WEBHOOK.startsWith("https://mekron-ai.app.n8n.cloud/webhook/53c136fe-3e77-4709-a143-fe82746dd8b6/chat")) {
        addRow('من فضلك حدّد رابط الويبهوك الصحيح في أعلى الملف (N8N_WEBHOOK).', 'sys');
        return;
      }

      addRow(text, 'me');
      input.value = '';
      input.focus();
      send.disabled = true;

      // رسالة "جارٍ الإرسال..."
      const pending = document.createElement('div');
      pending.className = 'row sys';
      pending.innerHTML = '<span class="loader"></span> جارٍ الحصول على الرد...';
      chat.appendChild(pending);
      chat.scrollTop = chat.scrollHeight;

      try {
        const res = await fetch(N8N_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // عدّل الحقول دي لو الـ n8n عندك متوقع format مختلف
          body: JSON.stringify({
            text,
            sessionId,
            meta: { source: 'mekron-vercel', ts: new Date().toISOString() }
          })
        });

        let payload;
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          payload = await res.json();
        } else {
          payload = await res.text();
        }

        pending.remove();

        if (!res.ok) {
          const t = extractTextFromUnknown(payload, `HTTP ${res.status}`);
          addRow(`خطأ من الخادم: ${t}`, 'sys');
          return;
        }

        const replyText = extractTextFromUnknown(payload, 'No response');
        addRow(replyText, 'bot');

      } catch (err){
        pending.remove();
        addRow('حصل خطأ في الاتصال بالويبهوك. تأكد أن الرابط شغّال وCORS مسموح.', 'sys');
        console.error(err);
      } finally {
        send.disabled = false;
      }
    }

    form.addEventListener('submit', sendMessage);

    // رسالة ترحيب
    addRow('مرحبًا! أنا Mekron. اكتب سؤالك وسيتم إرساله إلى n8n.', 'sys');
  </script>
</body>
</html>
